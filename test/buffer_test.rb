$:.unshift File.join(File.dirname(__FILE__),'..','lib')

require 'test/unit'
require 'wavefile.rb'

include WaveFile

class BufferTest < Test::Unit::TestCase
  def test_convert_buffer_channels
    # Assert that not changing the number of channels is a no-op
    b = Buffer.new([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767], Format.new(1, 16, 44100))
    b.convert!(Format.new(1, 16, 44100))
    assert_equal([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767], b.samples)

    b = Buffer.new([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767], Format.new(1, 16, 44100))
    b.convert!(Format.new(2, 16, 44100))
    assert_equal([[-32768, -32768], [-24576, -24576], [-16384, -16384], [-8192, -8192], [0, 0],
                  [8256, 8256], [16513, 16513], [24511, 24511], [32767, 32767]],
                 b.samples)

    b = Buffer.new([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767], Format.new(1, 16, 44100))
    b.convert!(Format.new(3, 16, 44100))
    assert_equal([[-32768, -32768, -32768], [-24576, -24576, -24576], [-16384, -16384, -16384], [-8192, -8192, -8192], [0, 0, 0],
                  [8256, 8256, 8256], [16513, 16513, 16513], [24511, 24511, 24511], [32767, 32767, 32767]],
                 b.samples)

    b = Buffer.new([[-32768, -32768], [-24576, -24576], [-16384, -16384], [-8192, -8192], [0, 0],
                            [8256, 8256], [16513, 16513], [24511, 24511], [32767, 32767]],
                   Format.new(2, 16, 44100))
    b.convert!(Format.new(1, 16, 44100))
    assert_equal([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767],
                 b.samples)

    b = Buffer.new([[-32768, -32768, -32768], [-24576, -24576, -24576], [-16384, -16384, -16384], [-8192, -8192, -8192], [0, 0, 0],
                            [8256, 8256, 8256], [16513, 16513, 16513], [24511, 24511, 24511], [32767, 32767, 32767]],
                   Format.new(3, 16, 44100))
    b.convert!(Format.new(1, 16, 44100))
    assert_equal([-32768, -24576, -16384, -8192, 0, 8256, 16513, 24511, 32767],
                 b.samples)
  end
end
